import logging
from aiogram import Bot, Dispatcher, types, executor
from aiogram.types import InlineKeyboardMarkup, InlineKeyboardButton, ReplyKeyboardMarkup, KeyboardButton, WebAppInfo

API_TOKEN = '8151754448:AAGFo8yeBd1CGgBIdOJb7Dgz4uuGcDTNQxU'

logging.basicConfig(level=logging.INFO)
bot = Bot(token=API_TOKEN)
dp = Dispatcher(bot)

# –ó–∞–≥–ª—É—à–∫–∏ –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–æ–≤
CAR_BRANDS = [
    "Acura", "Audi", "BMW", "Chevrolet", "Ford", "Honda", "Hyundai", "Kia", "Mercedes-Benz", "Toyota"
]

CAR_MODELS = {
    "Acura": [
        "MDX", "RDX", "TLX", "ILX", "RLX", "NSX", "ZDX", "TSX", "TL", "CL", "RSX", "Legend", "Vigor", "Integra", "SLX"
    ],
    "Audi": [
        "A3", "A4", "A5", "A6", "A7", "A8", "Q3", "Q5", "Q7", "Q8", "TT", "S3", "S4", "S5", "S6"
    ],
    "BMW": [
        "1 Series", "2 Series", "3 Series", "4 Series", "5 Series", "6 Series", "7 Series", "8 Series", "X1", "X2", "X3", "X4", "X5", "X6", "X7"
    ],
    "Chevrolet": [
        "Aveo", "Camaro", "Captiva", "Cobalt", "Colorado", "Corvette", "Cruze", "Equinox", "Impala", "Malibu", "Orlando", "Silverado", "Spark", "Suburban", "Tahoe"
    ],
    "Ford": [
        "C-Max", "EcoSport", "Edge", "Escape", "Expedition", "Explorer", "F-150", "Fiesta", "Focus", "Fusion", "Kuga", "Mondeo", "Mustang", "Ranger", "Transit"
    ],
    "Honda": [
        "Accord", "Civic", "CR-V", "CR-Z", "Element", "Fit", "HR-V", "Insight", "Jazz", "Odyssey", "Passport", "Pilot", "Prelude", "Ridgeline", "Stream"
    ],
    "Hyundai": [
        "Accent", "Creta", "Elantra", "Genesis", "Getz", "Grand Santa Fe", "i10", "i20", "i30", "ix35", "Kona", "Santa Fe", "Solaris", "Sonata", "Tucson"
    ],
    "Kia": [
        "Carens", "Carnival", "Ceed", "Cerato", "Forte", "K5", "Magentis", "Mohave", "Optima", "Picanto", "Rio", "Seltos", "Sorento", "Soul", "Sportage"
    ],
    "Mercedes-Benz": [
        "A-Class", "B-Class", "C-Class", "CLA", "CLS", "E-Class", "G-Class", "GLA", "GLB", "GLC", "GLE", "GLK", "GLS", "S-Class", "V-Class"
    ],
    "Toyota": [
        "Avalon", "Camry", "Corolla", "C-HR", "FJ Cruiser", "Highlander", "Land Cruiser", "Prius", "RAV4", "Sequoia", "Sienna", "Tacoma", "Tundra", "Venza", "Yaris"
    ]
}

CAR_YEARS = [str(y) for y in range(2005, 2026)]
DRIVE_TYPES = ["–ü–µ—Ä–µ–¥–Ω–∏–π", "–ó–∞–¥–Ω–∏–π", "–ü–æ–ª–Ω—ã–π"]
FUEL_TYPES = ["–ë–µ–Ω–∑–∏–Ω", "–î–∏–∑–µ–ª—å", "–≠–ª–µ–∫—Ç—Ä–æ", "–ì–∏–±—Ä–∏–¥", "–ì–∞–∑"]

# –ü—Ä–∏–º–µ—Ä —Ñ—É–Ω–∫—Ü–∏–∏-–∑–∞–≥–ª—É—à–∫–∏ –¥–ª—è –ø–∞—Ä—Å–∏–Ω–≥–∞ copart.com
def get_cars(brand, model, year_from, year_to, drive, fuel):
    # –ó–¥–µ—Å—å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –ø–∞—Ä—Å–µ—Ä copart.com, –∫–æ—Ç–æ—Ä—ã–π –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–ø–∏—Å–æ–∫ –∞–≤—Ç–æ
    # –ü—Ä–∏–º–µ—Ä —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞:
    return [
        {
            "brand": "Acura",
            "model": "MDX TECHNOLOGY",
            "year": "2020",
            "drive": "–ü–æ–ª–Ω—ã–π –ø—Ä–∏–≤–æ–¥",
            "fuel": "–ë–µ–Ω–∑–∏–Ω",
            "engine": "3.5–ª",
            "price": "12 000 $",
            "img": "https://example.com/acura1.jpg",
            "link": "https://copart.com/lot/12345678"
        },
        {
            "brand": "Acura",
            "model": "MDX TECHNOLOGY",
            "year": "2018",
            "drive": "–ü–æ–ª–Ω—ã–π –ø—Ä–∏–≤–æ–¥",
            "fuel": "–ë–µ–Ω–∑–∏–Ω",
            "engine": "3.5–ª",
            "price": "7 000 $",
            "img": "https://example.com/acura2.jpg",
            "link": "https://copart.com/lot/87654321"
        }
    ]

# –•—Ä–∞–Ω–∏–ª–∏—â–µ —Å–æ—Å—Ç–æ—è–Ω–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
user_filters = {}

@dp.message_handler(commands=['start'])
async def start_cmd(message: types.Message):
    webapp_url = "https://monax777.github.io/online-casino/"
    kb = ReplyKeyboardMarkup(resize_keyboard=True)
    kb.add(KeyboardButton("–û—Ç–∫—Ä—ã—Ç—å –ø–æ–¥–±–æ—Ä –∞–≤—Ç–æ", web_app=WebAppInfo(url=webapp_url)))
    await message.answer(
        "–ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ –¥–ª—è –ø–æ–¥–±–æ—Ä–∞ –∞–≤—Ç–æ üëá",
        reply_markup=kb
    )

# –ü—Ä–∏–º–µ—Ä —Ñ–∏–ª—å—Ç—Ä–æ–≤ —á–µ—Ä–µ–∑ –æ–±—ã—á–Ω—ã–µ –∫–Ω–æ–ø–∫–∏ (–µ—Å–ª–∏ –±–µ–∑ WebApp)
@dp.message_handler(lambda m: m.text == "–ü–æ–¥–æ–±—Ä–∞—Ç—å –∞–≤—Ç–æ")
async def show_filters(message: types.Message):
    kb = InlineKeyboardMarkup(row_width=2)
    for brand in CAR_BRANDS[:10]:
        kb.insert(InlineKeyboardButton(brand, callback_data=f"brand_{brand}"))
    await message.answer("–í—ã–±–µ—Ä–∏—Ç–µ –º–∞—Ä–∫—É:", reply_markup=kb)

@dp.callback_query_handler(lambda c: c.data.startswith("brand_"))
async def select_brand(call: types.CallbackQuery):
    brand = call.data.split("_", 1)[1]
    user_filters[call.from_user.id] = {"brand": brand}
    kb = InlineKeyboardMarkup(row_width=3)
    for year in CAR_YEARS:
        kb.insert(InlineKeyboardButton(year, callback_data=f"year_{year}"))
    await call.message.edit_text(f"–ú–∞—Ä–∫–∞: {brand}\n–í—ã–±–µ—Ä–∏—Ç–µ –≥–æ–¥ –≤—ã–ø—É—Å–∫–∞:", reply_markup=kb)

@dp.callback_query_handler(lambda c: c.data.startswith("year_"))
async def select_year(call: types.CallbackQuery):
    year = call.data.split("_", 1)[1]
    user_filters[call.from_user.id]["year"] = year
    kb = InlineKeyboardMarkup(row_width=2)
    for drive in DRIVE_TYPES:
        kb.insert(InlineKeyboardButton(drive, callback_data=f"drive_{drive}"))
    await call.message.edit_text(f"–ì–æ–¥: {year}\n–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø –ø—Ä–∏–≤–æ–¥–∞:", reply_markup=kb)

@dp.callback_query_handler(lambda c: c.data.startswith("drive_"))
async def select_drive(call: types.CallbackQuery):
    drive = call.data.split("_", 1)[1]
    user_filters[call.from_user.id]["drive"] = drive
    kb = InlineKeyboardMarkup(row_width=2)
    for fuel in FUEL_TYPES:
        kb.insert(InlineKeyboardButton(fuel, callback_data=f"fuel_{fuel}"))
    await call.message.edit_text(f"–ü—Ä–∏–≤–æ–¥: {drive}\n–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø —Ç–æ–ø–ª–∏–≤–∞:", reply_markup=kb)

@dp.callback_query_handler(lambda c: c.data.startswith("fuel_"))
async def select_fuel(call: types.CallbackQuery):
    fuel = call.data.split("_", 1)[1]
    user_filters[call.from_user.id]["fuel"] = fuel
    filters = user_filters[call.from_user.id]
    # –ü–æ–ª—É—á–∞–µ–º –∞–≤—Ç–æ (–∑–¥–µ—Å—å –±—É–¥–µ—Ç —Ä–µ–∞–ª—å–Ω—ã–π –ø–∞—Ä—Å–µ—Ä)
    cars = get_cars(filters["brand"], "", filters["year"], filters["year"], filters["drive"], fuel)
    if not cars:
        await call.message.edit_text("–ê–≤—Ç–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ –ø–æ –≤—ã–±—Ä–∞–Ω–Ω—ã–º –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º.")
        return
    for car in cars:
        text = (
            f"<b>{car['brand']} {car['model']}</b>\n"
            f"üóì –†—ñ–∫: {car['year']}\n"
            f"üõû {car['drive']}\n"
            f"‚õΩÔ∏è {car['fuel']}\n"
            f"üöó {car['engine']}\n\n"
            f"üí∞ –¶—ñ–Ω–∞ –≤ –°–®–ê: {car['price']}\n\n"
            f"–î–ª—è –ø—Ä–æ—Ä–∞—Ö—É–Ω–∫—É –≤–∞—Ä—Ç–æ—Å—Ç—ñ –ø—ñ–¥ –∫–ª—é—á –≤ –£–∫—Ä–∞—ó–Ω—É, —Ç–∏—Å–Ω—ñ—Ç—å –∫–Ω–æ–ø–∫—É ¬´–¶—ñ–Ω–∞ –ø—ñ–¥ –∫–ª—é—á¬ª üëá"
        )
        kb = InlineKeyboardMarkup()
        kb.add(InlineKeyboardButton("üîí –¶—ñ–Ω–∞ –ø—ñ–¥ –∫–ª—é—á", url=car['link']))
        await call.message.answer_photo(car['img'], caption=text, parse_mode="HTML", reply_markup=kb)

if __name__ == '__main__':
    executor.start_polling(dp, skip_updates=True)
